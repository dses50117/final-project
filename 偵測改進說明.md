# 疲勞偵測系統改進說明

## 問題診斷
您遇到的問題是：**打哈欠和閉眼睛都沒有被偵測出來**

## 根本原因
1. **閉眼時間要求過長** - 原本設定需要閉眼 2 秒才警報，正常眨眼或短暫閉眼無法觸發
2. **EAR 閾值過低** - 原本 0.2 的閾值可能對您的眼睛特徵不夠敏感
3. **連續幀數要求** - 需要連續 2 幀偵測到才警報，容易錯過瞬間動作
4. **模型敏感度預設過高** - 0.5 的機率閾值可能過於保守
5. **缺乏即時 MAR 顯示** - 無法看到打哈欠（MAR）的數值變化

## 已實施的改進

### 1. 降低偵測閾值
- **閉眼警報時間**: 2.0 秒 → **1.0 秒**
- **EAR 閾值**: 0.2 → **0.25**
- **連續幀數**: 2 幀 → **1 幀** （立即偵測）
- **模型敏感度**: 0.5 → **0.3**

### 2. 新增 UI 控制項
現在可以在側邊欄調整：
- **EAR 閾值** (0.15-0.35，預設 0.25)
- **閉眼警報時間** (0.5-3.0 秒，預設 1.0 秒)
- **模型敏感度** (0.1-0.9，預設 0.3)

### 3. 增強視覺回饋
在畫面上即時顯示：
- **EAR 值**：眼睛開合程度 (值越小=眼睛越閉)
- **MAR 值**：嘴巴開合程度 (值越大=打哈欠)
- **Prob 值**：模型判定的疲勞機率
- **狀態文字**：正常/疲勞偵測/閉眼時間

### 4. 改進偵測邏輯
- 降低連續幀數要求，讓系統更快速反應
- 顯示閉眼持續時間，讓您知道觸發警報的原因
- 同時使用模型判定和 EAR 判定，雙重保障

## 使用建議

### 首次使用時
1. **啟用校準功能**：
   - 勾選「啟用自適應 EAR」
   - 點擊「開始校準」按鈕
   - 保持眼睛自然睜開並正常眨眼 5-10 秒
   - 系統會自動計算適合您的 EAR 閾值

### 如果還是偵測不到
1. **降低 EAR 閾值**：在側邊欄調整到 0.20-0.22
2. **降低模型敏感度**：調整到 0.2-0.25
3. **縮短閉眼警報時間**：調整到 0.5-0.8 秒
4. **觀察數值變化**：
   - 正常睜眼時，EAR 應該 > 0.25
   - 閉眼時，EAR 應該 < 0.20
   - 打哈欠時，MAR 應該明顯上升 (> 0.5)

### 調試技巧
觀察畫面左上角的數值：
- **EAR 持續低於閾值** → 系統會開始計時
- **Prob 持續高於敏感度** → 模型判定為疲勞
- **MAR 突然上升** → 表示嘴巴張開（打哈欠）

## 測試方法
1. **測試閉眼偵測**：閉眼超過 1 秒，應該觸發警報
2. **測試打哈欠偵測**：張大嘴巴打哈欠，觀察 MAR 值上升，模型應該偵測到
3. **測試頭部動作**：低頭或側頭，pitch/yaw 變化會影響模型判定

## 注意事項
- 確保光線充足，避免背光
- 臉部完整出現在鏡頭中
- 與鏡頭保持適當距離 (30-50cm)
- 戴眼鏡可能影響 EAR 準確度，建議調低閾值

## 技術細節
- **EAR (Eye Aspect Ratio)**：眼睛高度/寬度比，< 0.25 視為閉眼
- **MAR (Mouth Aspect Ratio)**：嘴巴高度/寬度比，> 0.5 視為打哈欠
- **模型特徵**：[左 EAR, 右 EAR, MAR, Pitch, Yaw, Roll]
- **判定邏輯**：模型預測 OR 閉眼過久 → 觸發警報
